<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario Interactivo</title>
    <style>
        /* ... (mantener los estilos existentes) ... */
        .legend {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 0 10px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 5px;
        }
        .red { background-color: #ffcccc; }
        .yellow { background-color: #ffffcc; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Calendario Interactivo - Selección de Disponibilidad</h2>
        <div class="form-group">
            <label for="medico">Seleccionar Médico:</label>
            <select id="medico" onchange="cargarCalendario()"></select>
        </div>
        <div class="form-group">
            <label for="mes">Mes:</label>
            <select id="mes" onchange="generarCalendario()">
                <!-- ... (mantener las opciones de mes) ... -->
            </select>

            <label for="anio">Año:</label>
            <select id="anio" onchange="generarCalendario()"></select>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color red"></div>
                <span>No disponible</span>
            </div>
            <div class="legend-item">
                <div class="legend-color yellow"></div>
                <span>Preferencia de no trabajar</span>
            </div>
        </div>

        <button class="btn-save" onclick="guardarCambios()">Guardar cambios</button>

        <div class="calendario" id="calendario"></div>

        <nav>
            <a href="index.html">Volver al Inicio</a>
        </nav>
    </div>

    <script>
        const medicoSelect = document.getElementById('medico');
        const calendarioDiv = document.getElementById('calendario');
        const mesSelect = document.getElementById('mes');
        const anioSelect = document.getElementById('anio');
        let calendarioSeleccion = {};
        let seleccionInicio = null;

        window.onload = function() {
            cargarMedicos();
            cargarAnios();
            cargarCalendario();
        };

        function cargarMedicos() {
            const medicos = JSON.parse(localStorage.getItem('medicos')) || [];
            medicoSelect.innerHTML = '<option value="">Seleccione un médico</option>';
            medicos.forEach(medico => {
                const option = document.createElement('option');
                option.value = medico.correo;
                option.textContent = `${medico.nombre} ${medico.apellidos}`;
                medicoSelect.appendChild(option);
            });
        }

        function cargarAnios() {
            const anioActual = new Date().getFullYear();
            for (let i = anioActual - 10; i <= anioActual + 10; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                anioSelect.appendChild(option);
            }
            anioSelect.value = anioActual;
        }

        function cargarCalendario() {
            const correoMedico = medicoSelect.value;
            if (correoMedico) {
                calendarioSeleccion = JSON.parse(localStorage.getItem(correoMedico)) || {};
            } else {
                calendarioSeleccion = {};
            }
            generarCalendario();
        }

        function generarCalendario() {
            const mes = parseInt(mesSelect.value);
            const anio = parseInt(anioSelect.value);
            const correoMedico = medicoSelect.value;

            if (!correoMedico) {
                calendarioDiv.innerHTML = '<p>Por favor, seleccione un médico.</p>';
                return;
            }

            const diasSemana = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];
            const primerDia = new Date(anio, mes, 1).getDay();
            const ultimoDia = new Date(anio, mes + 1, 0).getDate();

            let calendarioHTML = diasSemana.map(dia => `<div class="header">${dia}</div>`).join('');

            let diaActual = 1;
            for (let i = 0; i < 42; i++) {
                if (i < (primerDia === 0 ? 6 : primerDia - 1) || diaActual > ultimoDia) {
                    calendarioHTML += '<div></div>';
                } else {
                    const fecha = `${anio}-${(mes + 1).toString().padStart(2, '0')}-${diaActual.toString().padStart(2, '0')}`;
                    const clase = calendarioSeleccion[fecha] === 'rojo' ? 'selected-red' : 
                                  calendarioSeleccion[fecha] === 'amarillo' ? 'selected-yellow' : '';
                    const esFinDeSemana = i % 7 === 5 || i % 7 === 6 ? 'weekend' : '';
                    calendarioHTML += `<div class="day ${esFinDeSemana} ${clase}" data-fecha="${fecha}">${diaActual}</div>`;
                    diaActual++;
                }
            }

            calendarioDiv.innerHTML = calendarioHTML;

            calendarioDiv.addEventListener('mousedown', iniciarSeleccion);
            calendarioDiv.addEventListener('mouseover', continuarSeleccion);
            calendarioDiv.addEventListener('mouseup', finalizarSeleccion);
        }

        function iniciarSeleccion(e) {
            if (e.target.classList.contains('day')) {
                seleccionInicio = e.target.dataset.fecha;
            }
        }

        function continuarSeleccion(e) {
            if (seleccionInicio && e.target.classList.contains('day')) {
                const fechaActual = e.target.dataset.fecha;
                aplicarSeleccion(seleccionInicio, fechaActual);
            }
        }

        function finalizarSeleccion() {
            seleccionInicio = null;
        }

        function aplicarSeleccion(inicio, fin) {
            const fechaInicio = new Date(inicio);
            const fechaFin = new Date(fin);
            const dias = document.querySelectorAll('.day');

            dias.forEach(dia => {
                const fecha = new Date(dia.dataset.fecha);
                if (fecha >= fechaInicio && fecha <= fechaFin) {
                    if (dia.classList.contains('selected-red')) {
                        dia.classList.remove('selected-red');
                        dia.classList.add('selected-yellow');
                        calendarioSeleccion[dia.dataset.fecha] = 'amarillo';
                    } else if (dia.classList.contains('selected-yellow')) {
                        dia.classList.remove('selected-yellow');
                        delete calendarioSeleccion[dia.dataset.fecha];
                    } else {
                        dia.classList.add('selected-red');
                        calendarioSeleccion[dia.dataset.fecha] = 'rojo';
                    }
                }
            });
        }

        function guardarCambios() {
            const correoMedico = medicoSelect.value;
            if (!correoMedico) {
                alert("Por favor, selecciona un médico.");
                return;
            }
            localStorage.setItem(correoMedico, JSON.stringify(calendarioSeleccion));
            alert("Cambios guardados correctamente.");
        }
    </script>
</body>
</html>
